# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: On Release
on:
  release:
    types:
      - published
      - released
      - prereleased
jobs:
  validate:
    name: Validate
    permissions:
      #-- Needed to clone the repository
      contents: read
    uses: ./.github/workflows/validate.yaml
    secrets:
      github-token: ${{secrets.GITHUB_TOKEN}}
  test-scenarios:
    name: Test Scenarios
    needs:
      - lint
      - validate
    permissions:
      #-- Needed to clone the repository
      contents: read
    strategy:
      fail-fast: true
      matrix:
        base-image:
          - debian:latest
          - ubuntu:latest
          - mcr.microsoft.com/devcontainers/base:ubuntu
    uses: ./.github/workflows/test-scenarios.yaml
    with:
      base-image: ${{matrix.base-image}}
    secrets:
      github-token: ${{secrets.GITHUB_TOKEN}}
  test-global:
    name: Test Global
    needs:
      - lint
      - validate
    permissions:
      #-- Needed to clone the repository
      contents: read
    uses: ./.github/workflows/test-global.yaml
    secrets:
      github-token: ${{secrets.GITHUB_TOKEN}}
  test-autogenerated:
    name: Test Autogenerated
    needs:
      - lint
      - validate
    permissions:
      #-- Needed to clone the repository
      contents: read
    strategy:
      fail-fast: true
      matrix:
        base-image:
          - debian:latest
          - ubuntu:latest
          - mcr.microsoft.com/devcontainers/base:ubuntu
    uses: ./.github/workflows/test-autogenerated.yaml
    with:
      base-image: ${{matrix.base-image}}
    secrets:
      github-token: ${{secrets.GITHUB_TOKEN}}
  lint:
    name: Lint
    permissions:
      #-- Needed to clone the repository
      contents: read
    uses: ./.github/workflows/lint.yaml
    secrets:
      github-token: ${{secrets.GITHUB_TOKEN}}
  publish-features:
    name: Publish Features
    if: github.ref == 'refs/heads/main'
    needs:
      - lint
      - validate
      - test-global
      - test-autogenerated
      - test-scenarios
    permissions:
      #-- Needed to clone repository
      contents: read
      #-- Needed to publish updated devcontainer features
      packages: write
    uses: ./.github/workflows/publish-features.yaml
    secrets:
      github-token: ${{secrets.GITHUB_TOKEN}}
  update-docs:
    name: Update Docs
    if: github.ref == 'refs/heads/main'
    needs:
      - lint
      - validate
      - test-global
      - test-autogenerated
      - test-scenarios
    permissions:
      #-- Needed to write to the repository
      contents: write
      #-- Needed to create a pull request
      pull-requests: write
    uses: ./.github/workflows/update-docs.yaml
    secrets:
      github-token: ${{secrets.GITHUB_TOKEN}}
